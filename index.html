<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa Group Game üéÑ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body {
      margin: 0; padding: 0;
      background: linear-gradient(135deg,#0f172a,#1e293b);
      color:#e5e7eb; min-height:100vh;
      display:flex; justify-content:center; align-items:flex-start;
    }
    .container{ background:rgba(15,23,42,0.97); max-width:1000px;width:100%;
      margin:16px;padding:18px 16px 24px;border-radius:18px;
      border:1px solid rgba(148,163,184,.4); box-shadow:0 20px 45px rgba(0,0,0,.45);
    }
    h1{ font-size:1.7rem;text-align:center;margin:4px 0 10px;}
    .tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
    .tab-btn{flex:1 1 150px;border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.8);color:#e5e7eb;padding:6px 10px;
      font-size:.8rem;font-weight:600;cursor:pointer;}
    .tab-btn.active{background:#22c55e;color:#052e16;border-color:#22c55e;}
    .panel{display:none;margin-top:4px;} .panel.active{display:block;}
    label{font-size:.8rem;display:block;margin:6px 0 2px;color:#cbd5f5;}
    input,textarea{width:100%;border-radius:10px;border:1px solid rgba(75,85,99,.9);
      background:rgba(15,23,42,.9);color:#e5e7eb;padding:7px 9px;font-size:.85rem;}
    textarea{min-height:70px;resize:vertical;}
    input:focus,textarea:focus{border-color:#22c55e;box-shadow:0 0 0 1px rgba(34,197,94,.3);}
    .btn-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
    button{border-radius:999px;border:none;padding:7px 14px;font-size:.8rem;
      font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
    .btn-main{background:#22c55e;color:#052e16;}
    .btn-ghost{background:transparent;color:#e5e7eb;border:1px solid rgba(148,163,184,.7);}
    .small{font-size:.75rem;color:#9ca3af;}
    .box{border-radius:12px;border:1px solid rgba(55,65,81,.8);
      padding:10px 10px;margin-top:8px;background:rgba(15,23,42,.8);}
    .toast{ position:fixed;bottom:16px;right:16px;background:rgba(15,23,42,.98);
      border-radius:999px;padding:7px 13px;font-size:.78rem;border:1px solid rgba(34,197,94,.7);
      color:#bbf7d0;box-shadow:0 12px 30px rgba(0,0,0,.6);
      opacity:0;transform:translateY(10px);pointer-events:none;transition:.18s;}
    .toast.show{opacity:1;transform:translateY(0);}
  </style>
</head>
<body>
<div class="container">

  <h1>Secret Santa Group Game üéÑ</h1>
  <p style="text-align:center;font-size:.85rem;color:#9ca3af;margin-bottom:10px;">
    Create a group ‚Üí Join with OTP ‚Üí Accept rules ‚Üí Admin starts the game.
  </p>

  <div class="tabs">
    <button class="tab-btn active" data-tab="admin-create">1. Admin: Create Group</button>
    <button class="tab-btn" data-tab="join">2. Participant: Join & Accept Rules</button>
    <button class="tab-btn" data-tab="admin-start">3. Admin: Start Game</button>
    <button class="tab-btn" data-tab="gift-status">4. Gift Status</button>
  </div>

  <!-- === Panel 1: Create Group === -->
  <div class="panel active" id="admin-create">
    <div class="box">
      <label>Group Name</label>
      <input id="inputGroupName" />
      <label style="margin-top:6px;">Admin Email</label>
      <input id="inputAdminEmail" />
      <div class="btn-row">
        <button class="btn-main" id="btnCreateGroup">Create Group & Get Code</button>
      </div>
      <p class="small" id="groupCodeInfo"></p>
    </div>
  </div>

  <!-- === Panel 2: Join Group === -->
  <div class="panel" id="join">
    <div class="box">
      <label>Group Code</label>
      <input id="inputJoinGroupCode" />
      <label>Your Name</label>
      <input id="inputJoinName" />
      <label>Your Email</label>
      <input id="inputJoinEmail" />
      <label>Your Wishlist</label>
      <textarea id="inputJoinWishlist"></textarea>

      <button class="btn-main" id="btnJoinGroup" style="margin-top:6px;">Join Group</button>
      <hr style="border:none;border-top:1px solid rgba(55,65,81,.7);margin:10px 0;">

      <label>Request OTP</label>
      <button class="btn-ghost" id="btnSendOtp">Send OTP to Email</button>
      <label style="margin-top:8px;">Enter OTP</label>
      <input id="inputOtp" />

      <label style="margin-top:6px;display:flex;gap:6px;font-size:.8rem;">
        <input type="checkbox" id="checkRules" style="width:14px;height:14px;">
        I accept all the rules.
      </label>

      <button class="btn-main" id="btnVerifyAccept">Verify & Accept Rules</button>
      <p class="small" id="joinStatus"></p>
    </div>
  </div>

  <!-- === Panel 3: Admin Start Game === -->
  <div class="panel" id="admin-start">
    <div class="box">
      <label>Group Code</label>
      <input id="inputAdminGroupCode" />
      <label>Admin Email</label>
      <input id="inputAdminStartEmail" />
      <div class="btn-row">
        <button class="btn-ghost" id="btnCheckStatus">Check Status</button>
        <button class="btn-main" id="btnStartGame" disabled>Start Game & Send Emails</button>
      </div>
      <p class="small" id="adminStatus"></p>
    </div>
  </div>

  <!-- === Panel 4: Gift Status === -->
  <div class="panel" id="gift-status">
    <div class="box">
      <label>Group Code</label>
      <input id="inputGiftGroupCode" />
      <label>Your Email</label>
      <input id="inputGiftEmail" />
      <label>Gift Photo (Drive Link)</label>
      <input id="inputGiftPhoto" />
      <label>Gift Status</label>
      <select id="selectGiftStatus"
        style="width:100%;border-radius:10px;margin-top:2px;border:1px solid rgba(75,85,99,.9);
        background:rgba(15,23,42,.9);color:#e5e7eb;padding:6px 9px;">
        <option value="RECEIVED">I got my gift üéÅ</option>
        <option value="NOT_RECEIVED">I did NOT receive my gift</option>
      </select>
      <button class="btn-main" id="btnUpdateGift" style="margin-top:8px;">Submit Gift Status</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  /* ================= API URL (Replace this!) ================= */
  const API_URL = "https://script.google.com/macros/s/AKfycbybtamuuyw-2dyMvYEk8hUBcrxndehoytxQLL_-KxCdqIIMY8reLEXq4seN8rdpnJOrMg/exec";

  /* Toast */
  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),2000);
  }

  /* POST JSON API */
  async function apiCall(action, payload){
    return fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, ...payload })
    }).then(r => r.json());
  }

  /* Tabs */
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });

  /* === Create Group === */
  btnCreateGroup.addEventListener('click', async ()=>{
    const groupNameValue = inputGroupName.value.trim();
    const adminEmailValue = inputAdminEmail.value.trim();
    if(!groupNameValue || !adminEmailValue) return showToast("Enter details");
    const res = await apiCall("createGroup",{ groupName: groupNameValue, adminEmail: adminEmailValue });
    if(res.ok){
      groupCodeInfo.textContent = `Group created! Code: ${res.groupCode}`;
      showToast("Group created");
    } else showToast(res.error || "Error");
  });

  /* === Join === */
  btnJoinGroup.addEventListener('click', async ()=>{
    const res = await apiCall("joinGroup",{
      groupCode: inputJoinGroupCode.value.trim(),
      name: inputJoinName.value.trim(),
      email: inputJoinEmail.value.trim(),
      wishlist: inputJoinWishlist.value.trim()
    });
    joinStatus.textContent = res.ok ? "Joined successfully" : res.error;
    showToast(res.ok ? "Joined" : res.error);
  });

  btnSendOtp.addEventListener('click', async ()=>{
    const res = await apiCall("sendOtp",{
      groupCode: inputJoinGroupCode.value.trim(),
      email: inputJoinEmail.value.trim()
    });
    joinStatus.textContent = res.ok ? "OTP sent" : res.error;
    showToast(res.ok ? "OTP sent" : res.error);
  });

  btnVerifyAccept.addEventListener('click', async ()=>{
    if(!checkRules.checked) return showToast("Accept rules first");
    const verify = await apiCall("verifyOtp",{
      groupCode: inputJoinGroupCode.value.trim(),
      email: inputJoinEmail.value.trim(),
      otp: inputOtp.value.trim()
    });
    if(!verify.ok) return showToast(verify.error);
    const accept = await apiCall("acceptRules",{
      groupCode: inputJoinGroupCode.value.trim(),
      email: inputJoinEmail.value.trim()
    });
    joinStatus.textContent = accept.ok ? "Rules accepted" : accept.error;
    showToast("Verified");
  });

  /* === Admin Start === */
  btnCheckStatus.addEventListener('click', async ()=>{
    const res = await apiCall("checkGroupStatus",{ groupCode: inputAdminGroupCode.value.trim() });
    adminStatus.textContent = res.ok
      ? `All accepted: ${res.allAccepted} ‚Ä¢ Started: ${res.started}`
      : res.error;
    btnStartGame.disabled = !(res.ok && res.allAccepted && res.started === "NO");
  });

  btnStartGame.addEventListener('click', async ()=>{
    const res = await apiCall("startGame",{ groupCode: inputAdminGroupCode.value.trim() });
    adminStatus.textContent = res.ok
      ? `Game started. Emails sent to ${res.count} players`
      : res.error;
    showToast(res.ok ? "Game started" : res.error);
  });

  /* === Gift Status === */
  btnUpdateGift.addEventListener('click', async ()=>{
    const res = await apiCall("updateGiftStatus",{
      groupCode: inputGiftGroupCode.value.trim(),
      email: inputGiftEmail.value.trim(),
      status: selectGiftStatus.value,
      photoUrl: inputGiftPhoto.value.trim()
    });
    showToast(res.ok ? "Status updated" : res.error);
  });

</script>
</body>
</html>
